<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Fila - Pronto Socorro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(49, 130, 206, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(49, 130, 206, 0); }
        }
        .patient-called { animation: pulse 2s infinite; }
        th, td { padding: 12px 16px; text-align: left; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Tela para o paciente inserir o nome via QR code -->
        <div id="qr-scan-container" class="hidden">
            <div class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Identificação do Paciente</h2>
                <p class="text-center mb-4">Por favor, insira o seu nome completo abaixo e clique em enviar.</p>
                <form id="qr-form">
                    <div class="mb-4">
                        <label for="qr-patient-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="qr-patient-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-lg">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Enviar Nome</button>
                </form>
            </div>
        </div>
        
        <!-- Container de Autenticação -->
        <div id="auth-container">
            <div id="login-view">
                <div class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login do Estabelecimento</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Entrar</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <p class="text-sm text-center mt-4">Não tem uma conta? <a href="#" id="show-register" class="font-medium text-blue-600 hover:text-blue-500">Registre-se</a></p>
                </div>
            </div>

            <div id="register-view" class="hidden">
                 <div class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Registro de Novo Estabelecimento</h2>
                    <form id="register-form">
                         <div class="mb-4">
                            <label for="register-name" class="block text-sm font-medium text-gray-700">Nome do Estabelecimento</label>
                            <input type="text" id="register-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="mb-4">
                            <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="register-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Registrar</button>
                    </form>
                    <p id="register-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <p class="text-sm text-center mt-4">Já tem uma conta? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Faça Login</a></p>
                </div>
            </div>
        </div>

        <!-- Container Principal da Aplicação (escondido até ao login) -->
        <div id="main-app-container" class="hidden">
            <header class="bg-white shadow-md rounded-lg p-4 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <div>
                      <h1 class="text-2xl sm:text-3xl font-bold text-blue-600">Pronto Socorro - Gestão de Fila</h1>
                      <p class="text-sm text-gray-600">Estabelecimento: <span id="establishment-name-display" class="font-semibold text-gray-800"></span></p>
                    </div>
                    <nav id="navigation" class="mt-4 sm:mt-0 flex flex-wrap gap-2 justify-center">
                        <button data-view="reception" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Recepção</button>
                        <button data-view="triage" class="nav-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Triagem</button>
                        <button data-view="doctor" class="nav-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Médico</button>
                        <button data-view="panel" class="nav-btn bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Painel</button>
                        <button data-view="monitoring" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Acompanhamento</button>
                        <button data-view="history" class="nav-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Histórico</button>
                    </nav>
                     <button id="logout-btn" class="mt-4 sm:mt-0 text-sm bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-3 rounded-lg">Sair</button>
                </div>
            </header>
            <main id="reception-view" class="view"></main>
            <main id="triage-view" class="view"></main>
            <main id="doctor-view" class="view"></main>
            <main id="panel-view" class="view"></main>
            <main id="monitoring-view" class="view"></main>
            <main id="history-view" class="view"></main>
        </div>
        
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div id="modal-content" class="mt-3 text-center"></div>
          </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, getDoc, serverTimestamp, query, orderBy, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
			apiKey: "AIzaSyCZOU5aaxwDpK-5NiDmYolOysbPNhs9to0",
			authDomain: "fila-de-atendimento-6b32c.firebaseapp.com",
			projectId: "fila-de-atendimento-6b32c",
			storageBucket: "fila-de-atendimento-6b32c.appspot.com",
			messagingSenderId: "60616234598",
			appId: "1:60616234598:web:911eb2e837cfe24ae6ffa7",
			measurementId: "G-87CDY00MBJ"
		};
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        let audioContext = null;
        let qrListenerUnsubscribe = null;

        const state = {
            user: null,
            patients: [],
            currentView: 'reception',
            lastCalledPatientId: null,
            unsubscribe: null, 
            historyData: {
                daily: { date: '', patients: [], summary: null, loading: false },
                monthly: { date: '', patients: [], summary: null, loading: false }
            }
        };

        const dom = {
            app: document.getElementById('app'),
            qrScanContainer: document.getElementById('qr-scan-container'),
            authContainer: document.getElementById('auth-container'),
            mainAppContainer: document.getElementById('main-app-container'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showRegisterBtn: document.getElementById('show-register'),
            showLoginBtn: document.getElementById('show-login'),
            loginError: document.getElementById('login-error'),
            registerError: document.getElementById('register-error'),
            establishmentNameDisplay: document.getElementById('establishment-name-display'),
            logoutBtn: document.getElementById('logout-btn'),
            views: document.querySelectorAll('#main-app-container .view'),
            navButtons: document.querySelectorAll('.nav-btn'),
            modal: document.getElementById('modal'),
            modalContent: document.getElementById('modal-content'),
        };
        
        const renderTemplates = {
            reception: () => {
                const waitingForTriage = state.patients.filter(p => p.status === 'aguardando-triagem' || p.status === 'chamado-triagem');
                return `
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Recepção - Admissão de Pacientes</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <form id="add-patient-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                             <div class="md:col-span-2">
                                <label for="patient-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="text" id="patient-name" required class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    <button type="button" data-action="show-qr" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-full" title="Gerar QR Code para paciente inserir nome">
                                        <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V4h2v2H5zM3 10a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm2 2v-2h2v2H5zM10 4a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1V4zm2 2V4h2v2h-2zM8 9a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button type="button" data-action="listen-name" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-full" title="Falar nome do paciente">
                                        <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path fill-rule="evenodd" d="M5.5 8.5A.5.5 0 016 9v1a4 4 0 004 4h.01a4 4 0 004-4V9a.5.5 0 011 0v1a5 5 0 01-4.5 4.975V17h1.5a.5.5 0 010 1h-5a.5.5 0 010-1H10v-2.025A5 5 0 015.5 10V9a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="patient-birthdate" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="date" id="patient-birthdate" required class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    <button type="button" data-action="calculate-age" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Calcular</button>
                                </div>
                                <span id="calculated-age" class="text-sm font-medium text-gray-900 mt-1 inline-block"></span>
                            </div>
                            <div class="md:col-span-3 flex items-center gap-4 pt-4"><div class="flex items-center h-5"><input id="is-priority" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="is-priority" class="font-medium text-gray-700">Atendimento Prioritário?</label></div></div>
                            <div class="md:col-span-3"><button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Paciente</button></div>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Aguardando Triagem (${waitingForTriage.length})</h3><div class="overflow-x-auto"><table class="w-full text-sm">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Cadastro</th><th>Nome</th><th>P</th><th>Idade</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody>${waitingForTriage.length > 0 ? waitingForTriage.map(p => `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td>${formatTimestamp(p.receptionTimestamp)}</td>
                                <td>${p.name}</td>
                                <td class="text-center font-bold">${p.isPriority ? 'P' : ''}</td>
                                <td>${p.age}</td>
                                <td><span class="px-2 py-1 text-xs rounded-full ${p.status === 'chamado-triagem' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">${p.status === 'chamado-triagem' ? 'CHAMADO' : 'AGUARDANDO'}</span></td>
                                <td><button data-action="delete-patient" data-id="${p.id}" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" title="Excluir Cadastro"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td>
                            </tr>`).join('') : '<tr><td colspan="6" class="text-center py-4">Nenhum paciente.</td></tr>'}
                        </tbody></table></div></div>`;
            },
            triage: () => { 
                const toTriage = state.patients.filter(p => p.status === 'aguardando-triagem' || p.status === 'chamado-triagem' || (p.status === 'em-triagem' && p.triagedBy === state.user.uid)); return `<h2 class="text-2xl font-semibold mb-4 text-gray-700">Triagem</h2> <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Pacientes para Triar (${toTriage.length})</h3><div class="overflow-x-auto"><table class="w-full text-sm"> <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Cadastro</th><th>Nome</th><th>P</th><th>Idade</th><th>Ações</th></tr></thead> <tbody>${toTriage.length > 0 ? toTriage.map(p => { let actionsHtml; if (p.status === 'em-triagem') { actionsHtml = '<span class="text-green-700 font-semibold">Em atendimento...</span>'; } else if (p.status === 'chamado-triagem') { actionsHtml = ` <button data-action="recall-triage" data-id="${p.id}" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Chamar Novamente</button> <button data-action="cancel-call-triage" data-id="${p.id}" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Cancelar</button> <button data-action="start-triage" data-id="${p.id}" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Atender</button> <button data-action="no-show-triage" data-id="${p.id}" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-xs">Não Compareceu</button> `; } else { actionsHtml = ` <button data-action="call-for-triage" data-id="${p.id}" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Chamar</button> <button data-action="start-triage" data-id="${p.id}" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Atender</button> <button data-action="no-show-triage" data-id="${p.id}" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-xs">Não Compareceu</button> `; } return `<tr class="bg-white border-b hover:bg-gray-50 ${p.status === 'em-triagem' ? 'bg-green-50' : ''}"><td>${formatTimestamp(p.receptionTimestamp)}</td><td>${p.name}</td><td class="text-center font-bold">${p.isPriority ? 'P' : ''}</td><td>${p.age}</td> <td class="flex items-center gap-2"> <div class="flex space-x-2 w-full">${actionsHtml}</div> <button data-action="delete-patient" data-id="${p.id}" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" title="Excluir Cadastro"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg> </button> </td></tr>` }).join('') : '<tr><td colspan="5" class="text-center py-4">Nenhum paciente.</td></tr>'} </tbody></table></div></div>`;
            },
            doctor: () => { 
                const sorter = (a, b) => (a.priority || 99) - (b.priority || 99) || (b.isPriority ? -1 : 1) - (a.isPriority ? -1 : 1) || a.triageTimestamp?.seconds - b.triageTimestamp?.seconds; const waiting = state.patients.filter(p => p.status === 'aguardando-atendimento').sort(sorter); const attended = state.patients.filter(p => (p.status === 'em-atendimento' || p.status === 'chamado-medico') && p.attendedBy === state.user.uid); let html = `<h2 class="text-2xl font-semibold mb-4 text-gray-700">Atendimento Médico</h2><div class="bg-white p-6 rounded-lg shadow-md">`; if(attended.length > 0) { html += attended.map(p => { const prio = getPriorityClass(p.priority); let actionButtonsHtml; if (p.status === 'chamado-medico') { actionButtonsHtml = ` <button data-action="recall-doctor" data-id="${p.id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Chamar Novamente</button> <button data-action="cancel-call-doctor" data-id="${p.id}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancelar</button> <button data-action="start-consultation" data-id="${p.id}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Atender</button> <button data-action="no-show-doctor" data-id="${p.id}" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Não Compareceu</button> `; } else { actionButtonsHtml = ` <button data-action="finish-consultation" data-id="${p.id}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Finalizar</button> <button data-action="no-show-doctor" data-id="${p.id}" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Não Compareceu</button> `; } return `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-red-500 mb-6"> <div class="flex justify-between items-start"> <div><p class="font-bold text-lg">${p.name} <span class="text-base font-normal text-gray-600">- ${p.age}</span></p> <span class="text-xs font-bold py-1 px-2 rounded-full ${prio.bgc} ${prio.textc}">${prio.text}</span> ${p.status === 'chamado-medico' ? `<p class="text-sm font-semibold text-red-700 mt-1">Chamado</p>` : ''}</div> <div class="flex items-center gap-2"> ${actionButtonsHtml} <button data-action="delete-patient" data-id="${p.id}" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" title="Excluir Cadastro"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg> </button> </div> </div> <div class="mt-4 border-t pt-4"> <textarea data-action="save-notes" data-id="${p.id}" class="mt-1 block w-full rounded-md p-2 border-gray-300" rows="4" placeholder="Anotações...">${p.doctorNotes || ''}</textarea> </div></div>`; }).join(''); } html += `<h3 class="text-xl font-semibold mb-2 border-b pb-2">Aguardando Atendimento (${waiting.length})</h3> <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Cadastro</th><th>Triagem</th><th>Nome</th><th>P</th><th>Idade</th><th>Ações</th></tr></thead><tbody>`; html += waiting.length > 0 ? waiting.map(p => { const prio = getPriorityClass(p.priority); return `<tr class="bg-white border-b hover:bg-gray-50"><td>${formatTimestamp(p.receptionTimestamp)}</td><td>${formatTimestamp(p.triageTimestamp)}</td><td>${p.name}</td><td class="text-center font-bold">${p.isPriority ? 'P' : ''}</td><td>${p.age}</td> <td class="flex items-center gap-2"> <button data-action="call-patient" data-id="${p.id}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-xs">Chamar</button> <button data-action="delete-patient" data-id="${p.id}" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" title="Excluir Cadastro"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg> </button> </td></tr>`; }).join('') : '<tr><td colspan="6" class="text-center py-4">Nenhum paciente.</td></tr>'; html += `</tbody></table></div></div>`; return html; 
            },
            panel: () => { 
                const called = state.patients.find(p => p.status === 'chamado-medico' || p.status === 'chamado-triagem'); let content = '<p class="text-2xl text-gray-500">Aguardando chamada...</p>'; if (called) { const type = called.status === 'chamado-medico' ? 'Atendimento Médico' : 'Triagem'; content = `<div class="p-6 rounded-lg bg-blue-50 border border-blue-200 patient-called"> <p class="text-4xl sm:text-5xl font-extrabold text-blue-700 break-words">${called.name}</p> <p class="text-2xl sm:text-3xl font-semibold text-gray-700 mt-2">Dirija-se à ${type}</p></div>`; } return `<h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Painel de Chamados</h2> <div class="bg-white p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-4 text-center border-b pb-2">PACIENTE CHAMADO</h3> <div id="panel-current-call" class="text-center py-8 min-h-[150px] flex items-center justify-center">${content}</div> </div>`; 
            },
            monitoring: () => { 
                const today = new Date();
                today.setHours(0,0,0,0);
                const attendedToday = state.patients.filter(p => p.status === 'atendido' && p.receptionTimestamp && p.receptionTimestamp.toDate() >= today);
                const sorter = (a, b) => (a.priority || 99) - (b.priority || 99) || (b.isPriority ? -1 : 1) - (a.isPriority ? -1 : 1) || a.triageTimestamp?.seconds - b.triageTimestamp?.seconds; 
                const waiting = state.patients.filter(p => p.status === 'aguardando-atendimento').sort(sorter); 
                return `<h2 class="text-2xl font-semibold mb-4 text-gray-700">Acompanhamento do Dia</h2> <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"> <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl text-center border-b pb-2 mb-4">Fila de Atendimento Médico (${waiting.length})</h3><div class="overflow-x-auto"><table class="w-full text-sm"> <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Cadastro</th><th>Prioridade</th><th>Nome</th><th>P</th><th>Ações</th></tr></thead><tbody> ${waiting.length > 0 ? waiting.map(p => { const prio = getPriorityClass(p.priority); return `<tr class="bg-white border-b"><td>${formatTimestamp(p.receptionTimestamp)}</td><td class="font-medium ${prio.textc} ${prio.bgc}">${prio.text}</td><td>${p.name}</td><td class="text-center font-bold">${p.isPriority ? 'P' : ''}</td><td><button data-action="delete-patient" data-id="${p.id}" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" title="Excluir Cadastro"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td></tr>`}).join('') : '<tr><td colspan="5" class="text-center py-4">Fila vazia.</td></tr>'} </tbody></table></div></div> <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl text-center border-b pb-2 mb-4">Pacientes Atendidos Hoje (${attendedToday.length})</h3><div class="overflow-x-auto"><table class="w-full text-sm"> <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Cadastro</th><th>Nome</th><th>P</th><th>Idade</th><th>Ações</th></tr></thead><tbody> ${attendedToday.length > 0 ? attendedToday.map(p => `<tr class="bg-white border-b"><td>${formatTimestamp(p.receptionTimestamp)}</td><td>${p.name}</td><td class="text-center font-bold">${p.isPriority ? 'P' : ''}</td><td>${p.age}</td><td><button data-action="delete-patient" data-id="${p.id}" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" title="Excluir Cadastro"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td></tr>`).join('') : '<tr><td colspan="5" class="text-center py-4">Nenhum atendido hoje.</td></tr>'} </tbody></table></div></div> </div>`; 
            },
            history: () => { 
                let dailySummaryHtml = '';
                if (state.historyData.daily.summary) {
                    const { total, classificationCounts } = state.historyData.daily.summary;
                    const classifications = Object.entries(classificationCounts).map(([level, count]) => {
                        const { text, bgc, textc } = getPriorityClass(parseInt(level));
                        return `<div class="p-2 rounded-md ${bgc} ${textc} text-sm"><strong>${text}:</strong> ${count}</div>`;
                    }).join('');
                    dailySummaryHtml = `
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Resumo do Dia ${formatDate(state.historyData.daily.date, true)}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-blue-700">${total}</p><p class="text-sm font-medium text-blue-600">Total de Atendimentos</p></div>
                                <div class="space-y-2">${classifications}</div>
                            </div>
                        </div>`;
                }

                let monthlySummaryHtml = '';
                if (state.historyData.monthly.summary) {
                     const { total, classificationCounts } = state.historyData.monthly.summary;
                    const classifications = Object.entries(classificationCounts).map(([level, count]) => {
                        const { text, bgc, textc } = getPriorityClass(parseInt(level));
                        return `<div class="p-2 rounded-md ${bgc} ${textc} text-sm"><strong>${text}:</strong> ${count}</div>`;
                    }).join('');
                    monthlySummaryHtml = `
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Resumo do Mês ${formatMonth(state.historyData.monthly.date)}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-purple-50 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-purple-700">${total}</p><p class="text-sm font-medium text-purple-600">Total de Atendimentos no Mês</p></div>
                                <div class="space-y-2">${classifications}</div>
                            </div>
                        </div>`;
                }
                
                return ` <h2 class="text-2xl font-semibold mb-4 text-gray-700">Histórico de Atendimentos</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                            <div class="flex items-end gap-4">
                                <div>
                                    <label for="history-date" class="block text-sm font-medium text-gray-700">Selecione a Data</label>
                                    <input type="date" id="history-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                                <button data-action="fetch-history" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">${state.historyData.daily.loading ? 'Buscando...' : 'Buscar Dia'}</button>
                            </div>
                            <div class="flex items-end gap-4">
                                <div>
                                    <label for="history-month" class="block text-sm font-medium text-gray-700">Selecione o Mês</label>
                                    <input type="month" id="history-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                                <button data-action="fetch-monthly-history" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">${state.historyData.monthly.loading ? 'Buscando...' : 'Buscar Mês'}</button>
                            </div>
                        </div>
                    </div>
                    ${monthlySummaryHtml}
                    ${dailySummaryHtml}
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Detalhes dos Atendimentos do Dia</h3>
                        <div class="overflow-x-auto"> <table class="w-full text-sm">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Paciente</th><th>Cadastro</th><th>Triagem</th><th>Atendimento</th><th>Status</th><th>Risco</th></tr></thead>
                        <tbody>
                            ${state.historyData.daily.patients.length > 0 ? state.historyData.daily.patients.map(p => {
                                const prio = getPriorityClass(p.priority);
                                return `<tr class="bg-white border-b hover:bg-gray-50">
                                    <td>${p.name}</td>
                                    <td>${formatTimestamp(p.receptionTimestamp)}</td>
                                    <td>${formatTimestamp(p.triageTimestamp)}</td>
                                    <td>${formatTimestamp(p.callTimestamp)}</td>
                                    <td>${getFinalStatusText(p.status)}</td>
                                    <td><span class="px-2 py-1 text-xs rounded-full ${prio.bgc} ${prio.textc}">${prio.text}</span></td>
                                </tr>`
                            }).join('') : `<tr><td colspan="6" class="text-center py-4">${state.historyData.daily.date ? 'Nenhum paciente encontrado para esta data.' : 'Selecione uma data para buscar.'}</td></tr>`}
                        </tbody>
                        </table></div>
                    </div>
                `; 
            },
        };
        
        // --- INICIALIZAÇÃO E ROTEAMENTO ---
        const urlParams = new URLSearchParams(window.location.search);
        const qrSessionId = urlParams.get('qrSessionId');
        const establishmentId = urlParams.get('establishmentId');

        if (qrSessionId && establishmentId) {
            dom.authContainer.classList.add('hidden');
            dom.mainAppContainer.classList.add('hidden');
            dom.qrScanContainer.classList.remove('hidden');

            const qrForm = document.getElementById('qr-form');
            qrForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = qrForm.querySelector('button');
                submitBtn.disabled = true;
                submitBtn.textContent = 'A enviar...';
                const patientName = document.getElementById('qr-patient-name').value;
                if(patientName) {
                    const sessionRef = doc(db, `establishments/${establishmentId}/qrSessions/${qrSessionId}`);
                    try {
                        await updateDoc(sessionRef, { name: patientName, status: 'completed' });
                        dom.qrScanContainer.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto text-center"><h2 class="text-2xl font-bold text-green-600">Obrigado!</h2><p class="mt-2">O seu nome foi enviado para a recepção.</p></div>`;
                    } catch(error) {
                        console.error("Erro ao enviar nome:", error);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar Nome';
                    }
                }
            });
        } else {
            onAuthStateChanged(auth, async (user) => {
                if (user && !user.isAnonymous) {
                    state.user = user;
                    const userDoc = await getDoc(doc(db, "establishments", user.uid));
                    if (userDoc.exists()) {
                        dom.establishmentNameDisplay.textContent = userDoc.data().name;
                    }
                    dom.authContainer.classList.add('hidden');
                    dom.mainAppContainer.classList.remove('hidden');
                    navigateTo('reception');
                    setupPatientListener(); 
                } else {
                    if (user && user.isAnonymous) await signOut(auth);
                    state.user = null;
                    if(state.unsubscribe) state.unsubscribe();
                    state.patients = [];
                    dom.loginForm.reset();
                    dom.registerForm.reset();
                    dom.loginError.textContent = '';
                    dom.registerError.textContent = '';
                    dom.authContainer.classList.remove('hidden');
                    dom.mainAppContainer.classList.add('hidden');
                }
            });
        }

        // --- LÓGICA DE AUTENTICAÇÃO ---
        dom.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            initAudioContext(); 
            const email = dom.loginForm['login-email'].value;
            const password = dom.loginForm['login-password'].value;
            const submitButton = dom.loginForm.querySelector('button[type="submit"]');

            dom.loginError.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'A entrar...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                dom.loginError.textContent = 'Credenciais inválidas. Verifique o seu email e senha, ou registre-se se for um novo usuário.';
                console.error("Erro de login:", error.code, error.message);
                submitButton.disabled = false;
                submitButton.textContent = 'Entrar';
            }
        });

        dom.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            initAudioContext();
            const name = dom.registerForm['register-name'].value;
            const email = dom.registerForm['register-email'].value;
            const password = dom.registerForm['register-password'].value;
            const submitButton = dom.registerForm.querySelector('button[type="submit"]');

            dom.registerError.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'Registrando...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "establishments", userCredential.user.uid), { name, email, createdAt: serverTimestamp() });
            } catch (error) {
                 dom.registerError.textContent = 'Erro ao registrar. O email pode já estar em uso ou a senha é muito fraca.';
                 console.error("Erro de registro:", error.code, error.message);
                 submitButton.disabled = false;
                 submitButton.textContent = 'Registrar';
            }
        });
        
        dom.logoutBtn.addEventListener('click', () => {
             if (qrListenerUnsubscribe) {
                qrListenerUnsubscribe();
                qrListenerUnsubscribe = null;
            }
            signOut(auth);
        });

        dom.showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); dom.loginView.classList.add('hidden'); dom.registerView.classList.remove('hidden'); });
        dom.showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); dom.registerView.classList.add('hidden'); dom.loginView.classList.remove('hidden'); });
        
        // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---
        function setupPatientListener() {
            if (state.unsubscribe) state.unsubscribe();
            if (!state.user) return; 

            const collectionPath = `establishments/${state.user.uid}/patients`;
            const q = query(collection(db, collectionPath), orderBy("receptionTimestamp", "desc"));
            
            state.unsubscribe = onSnapshot(q, (querySnapshot) => {
                state.patients = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Erro ao buscar pacientes: ", error));
        }

        function render() {
            if (!state.user) return;
            const activeViewElement = document.getElementById(`${state.currentView}-view`);
            if (activeViewElement) {
                const templateFunction = renderTemplates[state.currentView];
                if (templateFunction) activeViewElement.innerHTML = templateFunction();
                if (state.currentView === 'history' && !state.historyData.daily.date) {
                    const dateInput = document.getElementById('history-date');
                    const monthInput = document.getElementById('history-month');
                    if (dateInput) {
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        const day = today.getDate().toString().padStart(2, '0');
                        dateInput.value = `${year}-${month}-${day}`;
                        monthInput.value = `${year}-${month}`;
                    }
                }
            }

            const lastCalled = state.patients.find(p => p.status === 'chamado-medico' || p.status === 'chamado-triagem');
            if (lastCalled && state.lastCalledPatientId !== lastCalled.id) {
                state.lastCalledPatientId = lastCalled.id;
                
                const bellSound = new Audio('https://actions.google.com/sounds/v1/events/bell_notification.ogg');
                bellSound.play().catch(e => console.log("A reprodução do sino falhou:", e));

                bellSound.addEventListener('ended', () => {
                    const destination = lastCalled.status === 'chamado-medico' ? 'Atendimento Médico' : 'Triagem';
                    const textToSpeak = `${lastCalled.name}, dirija-se à ${destination}.`;
                    playGeminiTTS(textToSpeak);
                });
            }
        }
        
        function navigateTo(view) {
            state.currentView = view;
            dom.views.forEach(v => v.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');
            dom.navButtons.forEach(btn => btn.classList.toggle('ring-2', btn.dataset.view === view));
            render();
        }
        
        dom.navButtons.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));

        document.body.addEventListener('submit', async e => {
             if (e.target.id === 'add-patient-form') {
                e.preventDefault();
                const name = e.target['patient-name'].value.trim();
                const birthdate = e.target['patient-birthdate'].value;
                const isPriority = e.target['is-priority'].checked;
                const age = calculateAge(birthdate);

                if (name && birthdate && age && state.user) {
                    await addDoc(collection(db, `establishments/${state.user.uid}/patients`), { 
                        name, birthdate, age, isPriority, status: 'aguardando-triagem', receptionTimestamp: serverTimestamp() 
                    });
                    e.target.reset();
                    document.getElementById('calculated-age').textContent = '';
                }
            }
        });
        
        document.body.addEventListener('click', async e => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            if (!action) return;
            
            if (action === 'calculate-age') { const birthdate = document.getElementById('patient-birthdate').value; const ageDisplay = document.getElementById('calculated-age'); if (birthdate) ageDisplay.textContent = calculateAge(birthdate); else ageDisplay.textContent = 'Selecione uma data.'; return; }
            if (action === 'listen-name') { startSpeechRecognition(); return; }
            if (action === 'show-qr') { showQrModal(); return; }
            if (action === 'fetch-history') { await fetchHistory('daily'); return; }
            if (action === 'fetch-monthly-history') { await fetchHistory('monthly'); return; }

            const id = button.dataset.id;
            if (!id || !state.user) return;
            const patientRef = doc(db, `establishments/${state.user.uid}/patients`, id);
            
            if (action === 'submit-triage-priority') {
                const priority = parseInt(button.dataset.priority);
                if(priority) { 
                    await updateDoc(patientRef, { status: 'aguardando-atendimento', priority, triageTimestamp: serverTimestamp() }); 
                    hideModal(); 
                }
                return;
            }

            switch(action) {
                case 'delete-patient': showConfirmationModal('Tem a certeza que deseja excluir este paciente?', async () => { await deleteDoc(patientRef); hideModal(); }); break;
                case 'no-show-triage': showConfirmationModal('Confirmar não comparecimento do paciente para triagem?', async () => { await updateDoc(patientRef, { status: 'nao-compareceu-triagem', finishTimestamp: serverTimestamp() }); hideModal(); }); break;
                case 'no-show-doctor': showConfirmationModal('Confirmar não comparecimento do paciente para atendimento médico?', async () => { await updateDoc(patientRef, { status: 'nao-compareceu-medico', finishTimestamp: serverTimestamp() }); hideModal(); }); break;
                case 'recall-triage': await makeCall(id, 'triage'); break;
                case 'cancel-call-triage': await updateDoc(patientRef, { status: 'aguardando-triagem' }); break;
                case 'recall-doctor': await makeCall(id, 'doctor'); break;
                case 'cancel-call-doctor': await updateDoc(patientRef, { status: 'aguardando-atendimento' }); break;
                case 'start-consultation': await updateDoc(patientRef, { status: 'em-atendimento', callTimestamp: serverTimestamp() }); break;
                case 'call-for-triage': await makeCall(id, 'triage'); break;
                case 'start-triage': await updateDoc(patientRef, { status: 'em-triagem', triagedBy: state.user.uid }); showTriageModal(id); break;
                case 'call-patient': await makeCall(id, 'doctor'); break;
                case 'finish-consultation': await updateDoc(patientRef, { status: 'atendido', finishTimestamp: serverTimestamp() }); break;
            }
        });
        
        // --- FUNÇÕES AUXILIARES ---
        async function fetchHistory(type) {
            if (!state.user) return;
            
            let start, end, dateForState;
            if (type === 'daily') {
                const dateInput = document.getElementById('history-date');
                if (!dateInput || !dateInput.value) { showModal('<p>Por favor, selecione uma data válida.</p>'); return; }
                state.historyData.daily.loading = true;
                
                // CORREÇÃO: Tratar a data localmente para evitar problemas de fuso horário
                const [year, month, day] = dateInput.value.split('-').map(Number);
                start = new Date(year, month - 1, day, 0, 0, 0, 0);
                end = new Date(year, month - 1, day, 23, 59, 59, 999);
                dateForState = start;

            } else { // monthly
                const monthInput = document.getElementById('history-month');
                if (!monthInput || !monthInput.value) { showModal('<p>Por favor, selecione um mês válido.</p>'); return; }
                state.historyData.monthly.loading = true;
                const [year, month] = monthInput.value.split('-').map(Number);
                start = new Date(year, month - 1, 1);
                end = new Date(year, month, 0, 23, 59, 59, 999);
                dateForState = start;
            }
            render();

            try {
                const collectionPath = `establishments/${state.user.uid}/patients`;
                const q = query(collection(db, collectionPath), where("receptionTimestamp", ">=", start), where("receptionTimestamp", "<=", end));
                const querySnapshot = await getDocs(q);
                const patients = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const summary = { total: patients.length, classificationCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } };
                patients.forEach(p => { if (p.priority && summary.classificationCounts[p.priority] !== undefined) { summary.classificationCounts[p.priority]++; }});
                
                if (type === 'daily') {
                    state.historyData.daily.patients = patients.sort((a,b) => b.receptionTimestamp.seconds - a.receptionTimestamp.seconds);
                    state.historyData.daily.date = dateForState;
                    state.historyData.daily.summary = summary;
                } else {
                    state.historyData.monthly.date = dateForState;
                    state.historyData.monthly.summary = summary;
                }
            } catch(error) {
                console.error("Erro ao buscar histórico:", error);
                if (type === 'daily') { state.historyData.daily.patients = []; state.historyData.daily.summary = null; } 
                else { state.historyData.monthly.summary = null; }
                showModal('<p>Ocorreu um erro ao buscar o histórico. Verifique se o Firestore está configurado corretamente.</p>');
            } finally {
                if (type === 'daily') state.historyData.daily.loading = false;
                else state.historyData.monthly.loading = false;
                render();
            }
        }

        function initAudioContext() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
            } catch(e) { console.error("A Web Audio API não é suportada neste navegador.", e); }
        }

        async function playGeminiTTS(text) {
            if (!audioContext) { console.error("AudioContext não inicializado."); initAudioContext(); if (!audioContext) { console.warn("Fallback para voz do navegador."); if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'pt-BR'; window.speechSynthesis.speak(u); } return; }}
            console.log("Chamando Cloud Function 'generateSpeech'...");
            try {
                const generateSpeech = httpsCallable(functions, 'generateSpeech');
                const result = await generateSpeech({ text });
                const { audioData, mimeType, error } = result.data;
                if (error) throw new Error(error);
                if (audioData && mimeType) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("Taxa de amostragem não encontrada.");
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const audioBuffer = audioContext.createBuffer(1, pcmData.byteLength / 2, sampleRate);
                    const pcm16Data = new Int16Array(pcmData);
                    const float32Data = new Float32Array(pcm16Data.length);
                    for (let i = 0; i < pcm16Data.length; i++) { float32Data[i] = pcm16Data[i] / 32768.0; }
                    audioBuffer.copyToChannel(float32Data, 0);
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);
                    source.start();
                } else { throw new Error("Dados de áudio inválidos da Cloud Function."); }
            } catch (error) {
                console.error("Erro na Cloud Function ou reprodução de áudio:", error);
                if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'pt-BR'; window.speechSynthesis.speak(u); }
            }
        }

        async function showQrModal() {
            const qrSessionId = 'qr_' + Math.random().toString(36).substr(2, 9);
            const qrSessionRef = doc(db, `establishments/${state.user.uid}/qrSessions/${qrSessionId}`);
            try {
                await setDoc(qrSessionRef, { status: 'pending', createdAt: serverTimestamp() });
                const url = `${window.location.origin}${window.location.pathname}?establishmentId=${state.user.uid}&qrSessionId=${qrSessionId}`;
                const content = `<h3 class="text-lg font-medium text-gray-900">Leitura de QR Code</h3><p class="text-sm text-gray-600 mt-2">Peça ao paciente para ler o código abaixo com a câmara do telemóvel para inserir o seu nome.</p><div class="flex justify-center my-4"><canvas id="qrcode-canvas"></canvas></div><p class="text-center font-semibold">A aguardar o nome do paciente...</p><button data-action="close-modal" class="mt-4 w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-md">Cancelar</button>`;
                showModal(content);
                QRCode.toCanvas(document.getElementById('qrcode-canvas'), url, { width: 256 }, function (error) { if (error) console.error(error); });
                if (qrListenerUnsubscribe) qrListenerUnsubscribe();
                qrListenerUnsubscribe = onSnapshot(qrSessionRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().status === 'completed') {
                        document.getElementById('patient-name').value = docSnap.data().name;
                        hideModal();
                        deleteDoc(qrSessionRef);
                    }
                });
            } catch (error) { console.error("Erro ao criar sessão QR:", error); showModal('<p>Não foi possível gerar o QR code. Tente novamente.</p>'); }
        }

        function base64ToArrayBuffer(base64) { const b = window.atob(base64); const l = b.length; const u = new Uint8Array(l); for (let i = 0; i < l; i++) { u[i] = b.charCodeAt(i); } return u.buffer; }
        function calculateAge(birthDateString) { if (!birthDateString) return ''; const birthDate = new Date(birthDateString); birthDate.setUTCHours(12); const today = new Date(); let years = today.getFullYear() - birthDate.getFullYear(); let months = today.getMonth() - birthDate.getMonth(); let days = today.getDate() - birthDate.getDate(); if (months < 0 || (months === 0 && days < 0)) { years--; months = (months + 12) % 12; } if (days < 0) { const p = new Date(today.getFullYear(), today.getMonth(), 0); days += p.getDate(); months--; if (months < 0) { months = 11; years--; } } if (years > 0) return `${years} ${years > 1 ? 'anos' : 'ano'}`; if (months > 0) return `${months} ${months > 1 ? 'meses' : 'mês'}`; return `${days} ${days > 1 ? 'dias' : 'dia'}`; }
        function startSpeechRecognition() { 
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition; 
            if (!SR) { 
                showModal('<p>O seu navegador não suporta reconhecimento de voz.</p>'); 
                return; 
            } 
            const r = new SR(); 
            r.lang = 'pt-BR'; 
            r.interimResults = false; 
            r.maxAlternatives = 1; 
            const i = document.getElementById('patient-name'); 
            const b = document.querySelector('[data-action="listen-name"]'); 
            const s = b.innerHTML; 
            b.innerHTML = `<svg class="h-5 w-5 text-red-500 animate-pulse" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path fill-rule="evenodd" d="M5.5 8.5A.5.5 0 016 9v1a4 4 0 004 4h.01a4 4 0 004-4V9a.5.5 0 011 0v1a5 5 0 01-4.5 4.975V17h1.5a.5.5 0 010 1h-5a.5.5 0 010-1H10v-2.025A5 5 0 015.5 10V9a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>`; 
            r.start(); 
            r.onresult = (e) => { 
                const t = e.results[0][0].transcript; 
                i.value = t.charAt(0).toUpperCase() + t.slice(1); 
            }; 
            r.onspeechend = () => r.stop(); 
            r.onend = () => b.innerHTML = s; 
            r.onerror = (e) => { 
                console.error('Erro:', e.error); 
                b.innerHTML = s; 
            }; 
        }
        function showModal(content) { dom.modal.classList.remove('hidden'); dom.modalContent.innerHTML = content; }
        function hideModal() { if (qrListenerUnsubscribe) { qrListenerUnsubscribe(); qrListenerUnsubscribe = null; } dom.modal.classList.add('hidden'); dom.modalContent.innerHTML = ''; }
        dom.modal.addEventListener('click', e => { if (e.target.id === 'modal' || e.target.matches('[data-action="close-modal"]')) hideModal(); });
        function showConfirmationModal(message, onConfirm) { const c = ` <p class="text-lg font-medium text-gray-800">${message}</p> <div class="mt-6 flex justify-end gap-4"> <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button> <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md">Confirmar</button> </div> `; showModal(c); document.getElementById('modal-confirm-btn').onclick = onConfirm; document.getElementById('modal-cancel-btn').onclick = hideModal; }
        async function makeCall(patientId, callType) { const c = `establishments/${state.user.uid}/patients`; const p = state.patients.find(p => p.status === 'chamado-medico' || p.status === 'chamado-triagem'); if (p && p.id !== patientId) { const r = doc(db, c, p.id); const s = p.status === 'chamado-medico' ? 'aguardando-atendimento' : 'aguardando-triagem'; await updateDoc(r, { status: s }); } const n = doc(db, c, patientId); const d = { status: callType === 'doctor' ? 'chamado-medico' : 'chamado-triagem', callTimestamp: serverTimestamp() }; if (callType === 'doctor') d.attendedBy = state.user.uid; await updateDoc(n, d); }
        function showTriageModal(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            const content = `
                <h3 class="text-lg leading-6 font-medium text-gray-900">${patient.name}</h3>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 text-left mb-2">Selecione o Nível de Prioridade</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button data-action="submit-triage-priority" data-id="${patientId}" data-priority="1" class="w-full text-left p-3 rounded-lg font-bold bg-red-600 hover:bg-red-700 text-white">1 - EMERGÊNCIA</button>
                        <button data-action="submit-triage-priority" data-id="${patientId}" data-priority="2" class="w-full text-left p-3 rounded-lg font-bold bg-orange-500 hover:bg-orange-600 text-white">2 - MUITO URGENTE</button>
                        <button data-action="submit-triage-priority" data-id="${patientId}" data-priority="3" class="w-full text-left p-3 rounded-lg font-bold bg-yellow-400 hover:bg-yellow-500 text-black">3 - URGENTE</button>
                        <button data-action="submit-triage-priority" data-id="${patientId}" data-priority="4" class="w-full text-left p-3 rounded-lg font-bold bg-green-500 hover:bg-green-600 text-white">4 - POUCO URGENTE</button>
                        <button data-action="submit-triage-priority" data-id="${patientId}" data-priority="5" class="w-full text-left p-3 rounded-lg font-bold bg-blue-500 hover:bg-blue-600 text-white">5 - NÃO URGENTE</button>
                    </div>
                </div>
                <div class="mt-6">
                    <button data-action="close-modal" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-md">Cancelar</button>
                </div>`;
            showModal(content);
        }
        function formatTimestamp(ts) { if (!ts) return '-'; return new Date(ts.seconds * 1000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); }
        function formatDate(ts, fromDateObject = false) { if (!ts) return '-'; const date = fromDateObject ? ts : new Date(ts.seconds * 1000); return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });}
        function formatMonth(date) { if (!date) return ''; return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());}
        function formatFullTimestamp(ts) { if (!ts) return '-'; return new Date(ts.seconds * 1000).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
        function getPriorityClass(p) { switch(p) { case 1: return { text: 'EMERGÊNCIA', bgc: 'bg-red-100', textc: 'text-red-800' }; case 2: return { text: 'MUITO URGENTE', bgc: 'bg-orange-100', textc: 'text-orange-800' }; case 3: return { text: 'URGENTE', bgc: 'bg-yellow-100', textc: 'text-yellow-800' }; case 4: return { text: 'POUCO URGENTE', bgc: 'bg-green-100', textc: 'text-green-800' }; case 5: return { text: 'NÃO URGENTE', bgc: 'bg-blue-100', textc: 'text-blue-800' }; default: return { text: 'N/A', bgc: 'bg-gray-100', textc: 'text-gray-800' }; } }
        function getFinalStatusText(status) { switch(status) { case 'atendido': return 'Atendido'; case 'nao-compareceu-triagem': return 'Não Compareceu (Triagem)'; case 'nao-compareceu-medico': return 'Não Compareceu (Médico)'; default: 'Finalizado'; } }
    </script>
</body>
</html>
