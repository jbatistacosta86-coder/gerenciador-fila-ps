<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Fila - Pronto Socorro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(49, 130, 206, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px 10px rgba(49, 130, 206, 0);
            }
        }
        .patient-called {
            animation: pulse 2s infinite;
        }
        .gemini-response {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: left;
            font-size: 0.875rem;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        th, td {
            padding: 12px 16px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Tela de Login e Registro (visível antes de autenticar) -->
        <div id="auth-container">
            <main id="login-view" class="view active">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md mt-10">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Acessar Unidade</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-unit-name" class="block text-sm font-medium text-gray-700">Nome da Unidade</label>
                            <input type="text" id="login-unit-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Ex: Hospital Central">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Senha de Acesso</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Entrar</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-center text-sm mt-4"></p>
                    <p class="text-center text-sm text-gray-600 mt-4">
                        Não tem uma unidade? <a href="#" id="show-register" class="font-medium text-blue-600 hover:text-blue-500">Cadastre aqui</a>
                    </p>
                </div>
            </main>

            <main id="register-view" class="view">
                 <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md mt-10">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Cadastrar Nova Unidade</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-unit-name" class="block text-sm font-medium text-gray-700">Nome da Unidade</label>
                            <input type="text" id="register-unit-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Ex: Hospital Central">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-sm font-medium text-gray-700">Crie uma Senha</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Cadastrar</button>
                    </form>
                    <p id="register-error" class="text-red-500 text-center text-sm mt-4"></p>
                     <p class="text-center text-sm text-gray-600 mt-4">
                        Já tem cadastro? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Acesse aqui</a>
                    </p>
                </div>
            </main>
        </div>
        
        <!-- Container Principal da Aplicação (visível após autenticar) -->
        <div id="main-app-container" class="hidden">
            <!-- Cabeçalho e Navegação -->
            <header class="bg-white shadow-md rounded-lg p-4 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <div>
                      <h1 class="text-2xl sm:text-3xl font-bold text-blue-600">Pronto Socorro - Gestão de Fila</h1>
                      <p class="text-sm text-gray-600">Unidade: <span id="unit-name-display" class="font-semibold"></span></p>
                    </div>
                    <nav id="navigation" class="mt-4 sm:mt-0 flex flex-wrap gap-2 justify-center">
                        <button data-view="reception" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Recepção</button>
                        <button data-view="triage" class="nav-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Triagem</button>
                        <button data-view="doctor" class="nav-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Médico</button>
                        <button data-view="panel" class="nav-btn bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Painel</button>
                        <button data-view="monitoring" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Acompanhamento</button>
                        <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-sm">Sair</button>
                    </nav>
                </div>
            </header>

            <!-- Telas da Aplicação -->
            <main id="reception-view" class="view"></main>
            <main id="triage-view" class="view"></main>
            <main id="doctor-view" class="view"></main>
            <main id="panel-view" class="view"></main>
            <main id="monitoring-view" class="view"></main>
        </div>

        <div id="loading" class="text-center p-10 hidden">
            <p class="text-lg font-semibold text-gray-600">Carregando...</p>
        </div>
        
        <!-- Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
          <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div id="modal-content" class="mt-3 text-center"></div>
          </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ATENÇÃO: COLE SUAS CONFIGURAÇÕES AQUI ---
        const firebaseConfig = {
			apiKey: "AIzaSyCZOU5aaxwDpK-5NiDmYolOysbPNhs9to0",
			authDomain: "fila-de-atendimento-6b32c.firebaseapp.com",
			projectId: "fila-de-atendimento-6b32c",
			storageBucket: "fila-de-atendimento-6b32c.firebasestorage.app",
			messagingSenderId: "60616234598",
			appId: "1:60616234598:web:911eb2e837cfe24ae6ffa7",
			measurementId: "G-87CDY00MBJ"
		};
        const geminiApiKey = "AIzaSyDG53kdnsGV6B9MxMsFyNOf1GLtPaDAo4k"; 
        // ---------------------------------------------
        
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${AIzaSyDG53kdnsGV6B9MxMsFyNOf1GLtPaDAo4k}`;
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const state = {
            user: null,
            unitName: '',
            patients: [],
            currentView: 'reception',
            lastCalledPatientId: null,
            debounceTimer: null,
        };

        const dom = {
            authContainer: document.getElementById('auth-container'),
            mainAppContainer: document.getElementById('main-app-container'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showRegisterLink: document.getElementById('show-register'),
            showLoginLink: document.getElementById('show-login'),
            loginError: document.getElementById('login-error'),
            registerError: document.getElementById('register-error'),
            unitNameDisplay: document.getElementById('unit-name-display'),
            logoutBtn: document.getElementById('logout-btn'),
            views: document.querySelectorAll('#main-app-container .view'),
            navButtons: document.querySelectorAll('.nav-btn'),
            loading: document.getElementById('loading'),
            modal: document.getElementById('modal'),
            modalContent: document.getElementById('modal-content'),
        };

        const renderTemplates = {
            reception: () => {
                const waitingForTriage = state.patients.filter(p => p.status === 'aguardando-triagem' || p.status === 'chamado-triagem');
                return `
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Recepção - Admissão de Pacientes</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <form id="add-patient-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div class="md:col-span-2"><label for="patient-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="patient-name" required class="mt-1 block w-full rounded-md p-2"></div>
                            <div><label for="patient-age" class="block text-sm font-medium text-gray-700">Idade</label><input type="number" id="patient-age" required class="mt-1 block w-full rounded-md p-2"></div>
                            <div class="md:col-span-3 flex items-center gap-4"><div class="flex items-center h-5"><input id="is-priority" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 rounded"></div><div class="ml-3 text-sm"><label for="is-priority" class="font-medium text-gray-700">Atendimento Prioritário?</label><p class="text-gray-500">Marque se o paciente tem prioridade legal.</p></div></div>
                            <div class="md:col-span-3"><button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Paciente</button></div>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Aguardando Triagem</h3><div class="overflow-x-auto"><table class="w-full text-sm">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Hora</th><th>Nome</th><th>Idade</th><th>Status</th></tr></thead>
                        <tbody>${waitingForTriage.length > 0 ? waitingForTriage.map(p => `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td>${formatTimestamp(p.receptionTimestamp)}</td><td>${p.isPriority ? '⭐' : ''} ${p.name}</td><td>${p.age}</td>
                                <td><span class="px-2 py-1 text-xs rounded-full ${p.status === 'chamado-triagem' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">${p.status === 'chamado-triagem' ? 'CHAMADO' : 'AGUARDANDO'}</span></td>
                            </tr>`).join('') : '<tr><td colspan="4" class="text-center py-4">Nenhum paciente.</td></tr>'}
                        </tbody></table></div></div>`;
            },
            triage: () => {
                const toTriage = state.patients.filter(p => p.status === 'aguardando-triagem' || p.status === 'chamado-triagem' || (p.status === 'em-triagem' && p.triagedBy === state.user.uid));
                return `
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Triagem</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Pacientes para Triar (${toTriage.length})</h3><div class="overflow-x-auto"><table class="w-full text-sm">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Hora</th><th>Nome</th><th>Idade</th><th>Ações</th></tr></thead>
                        <tbody>${toTriage.length > 0 ? toTriage.map(p => `
                            <tr class="bg-white border-b hover:bg-gray-50 ${p.status === 'em-triagem' ? 'bg-green-50' : ''}">
                                <td>${formatTimestamp(p.receptionTimestamp)}</td><td>${p.isPriority ? '⭐' : ''} ${p.name}</td><td>${p.age}</td>
                                <td>${p.status === 'em-triagem' ? '<span class="text-green-700 font-semibold">Em atendimento...</span>' : `<div class="flex space-x-2">
                                   <button data-action="call-for-triage" data-id="${p.id}" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Chamar</button>
                                   <button data-action="start-triage" data-id="${p.id}" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-xs">Atender</button>
                                </div>`}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4">Nenhum paciente.</td></tr>'}
                        </tbody></table></div></div>`;
            },
            doctor: () => {
                const sorter = (a, b) => (a.priority || 99) - (b.priority || 99) || (b.isPriority ? -1 : 1) - (a.isPriority ? -1 : 1) || a.triageTimestamp?.seconds - b.triageTimestamp?.seconds;
                const waiting = state.patients.filter(p => p.status === 'aguardando-atendimento').sort(sorter);
                const attended = state.patients.filter(p => (p.status === 'em-atendimento' || p.status === 'chamado-medico') && p.attendedBy === state.user.uid);
                let html = `<h2 class="text-2xl font-semibold mb-4 text-gray-700">Atendimento Médico</h2><div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Aguardando Atendimento (${waiting.length})</h3>`;
                if(attended.length > 0) {
                     html += attended.map(p => {
                        const prio = getPriorityClass(p.priority);
                        return `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-red-500 mb-6">
                               <div class="flex justify-between items-start">
                                   <div><p class="font-bold text-lg">${p.isPriority ? '⭐' : ''} ${p.name} <span class="text-base font-normal text-gray-600">- ${p.age} anos</span></p>
                                   <span class="text-xs font-bold py-1 px-2 rounded-full ${prio.bgc} ${prio.textc}">${prio.text}</span>
                                   ${p.status === 'chamado-medico' ? `<p class="text-sm font-semibold text-red-700 mt-1">Chamado</p>` : ''}</div>
                                   <button data-action="finish-consultation" data-id="${p.id}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Finalizar</button>
                               </div>
                               <div class="mt-4 border-t pt-4">
                                   <textarea data-action="save-notes" data-id="${p.id}" class="mt-1 block w-full rounded-md p-2" rows="4" placeholder="Anotações...">${p.doctorNotes || ''}</textarea>
                                   <button data-action="generate-summary" data-id="${p.id}" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg text-sm">✨ Gerar Resumo (SOAP)</button>
                                   <div id="soap-summary-${p.id}" class="mt-2">${p.soapSummary ? `<div class="gemini-response">${p.soapSummary}</div>` : ''}</div>
                               </div></div>`;
                    }).join('');
                }
                html += `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Prioridade</th><th>Chegada</th><th>Nome</th><th>Idade</th><th>Ações</th></tr></thead><tbody>`;
                html += waiting.length > 0 ? waiting.map(p => {
                    const prio = getPriorityClass(p.priority);
                    return `<tr class="bg-white border-b hover:bg-gray-50">
                                <td><span class="px-2 py-1 text-xs rounded-full ${prio.bgc} ${prio.textc}">${prio.text}</span></td>
                                <td>${formatTimestamp(p.receptionTimestamp)}</td><td>${p.isPriority ? '⭐' : ''} ${p.name}</td><td>${p.age}</td>
                                <td><button data-action="call-patient" data-id="${p.id}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-xs">Chamar</button></td></tr>`;
                }).join('') : '<tr><td colspan="5" class="text-center py-4">Nenhum paciente.</td></tr>';
                html += `</tbody></table></div></div>`;
                return html;
            },
            panel: () => {
                const called = state.patients.find(p => p.status === 'chamado-medico' || p.status === 'chamado-triagem');
                let content = '<p class="text-2xl text-gray-500">Aguardando chamada...</p>';
                if (called) {
                    const type = called.status === 'chamado-medico' ? 'Atendimento Médico' : 'Triagem';
                    content = `<div class="p-6 rounded-lg bg-blue-50 border border-blue-200 patient-called">
                            <p class="text-4xl sm:text-5xl font-extrabold text-blue-700 break-words">${called.name}</p>
                            <p class="text-2xl sm:text-3xl font-semibold text-gray-700 mt-2">Dirija-se à ${type}</p></div>`;
                }
                return `<h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Painel de Chamados</h2>
                        <div class="bg-white p-6 rounded-lg shadow-xl">
                            <h3 class="text-xl font-semibold mb-4 text-center border-b pb-2">PACIENTE CHAMADO</h3>
                            <div id="panel-current-call" class="text-center py-8 min-h-[150px] flex items-center justify-center">${content}</div>
                        </div>`;
            },
            monitoring: () => {
                 const sorter = (a, b) => (a.priority || 99) - (b.priority || 99) || (b.isPriority ? -1 : 1) - (a.isPriority ? -1 : 1) || a.triageTimestamp?.seconds - b.triageTimestamp?.seconds;
                const waiting = state.patients.filter(p => p.status === 'aguardando-atendimento').sort(sorter);
                const history = state.patients.filter(p => p.callTimestamp).sort((a, b) => b.callTimestamp.seconds - a.callTimestamp.seconds).slice(0, 10);
                const attended = state.patients.filter(p => p.status === 'atendido');
                return `<h2 class="text-2xl font-semibold mb-4 text-gray-700">Acompanhamento</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl text-center border-b pb-2 mb-4">Fila de Atendimento Médico</h3><div class="overflow-x-auto"><table class="w-full text-sm">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Prioridade</th><th>Nome</th></tr></thead><tbody>
                                ${waiting.length > 0 ? waiting.map(p => { const prio = getPriorityClass(p.priority); return `<tr class="bg-white border-b"><td class="font-medium ${prio.textc} ${prio.bgc}">${prio.text}</td><td>${p.isPriority ? '⭐' : ''} ${p.name}</td></tr>`}).join('') : '<tr><td colspan="2" class="text-center py-4">Fila vazia.</td></tr>'}
                                </tbody></table></div></div>
                            <div class="space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl text-center border-b pb-2 mb-4">Histórico de Chamados</h3><div class="overflow-x-auto"><table class="w-full text-sm">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Hora</th><th>Nome</th></tr></thead><tbody>
                                    ${history.length > 0 ? history.map(p => `<tr class="bg-white border-b"><td>${formatTimestamp(p.callTimestamp)}</td><td>${p.name}</td></tr>`).join('') : '<tr><td colspan="2" class="text-center py-4">Nenhum chamado.</td></tr>'}
                                </tbody></table></div></div>
                                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl text-center border-b pb-2 mb-4">Pacientes Atendidos (${attended.length})</h3><div class="overflow-x-auto"><table class="w-full text-sm">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th>Admissão</th><th>Nome</th><th>Idade</th></tr></thead><tbody>
                                    ${attended.length > 0 ? attended.map(p => `<tr class="bg-white border-b"><td>${formatTimestamp(p.receptionTimestamp)}</td><td>${p.isPriority ? '⭐' : ''} ${p.name}</td><td>${p.age}</td></tr>`).join('') : '<tr><td colspan="3" class="text-center py-4">Nenhum atendido.</td></tr>'}
                                </tbody></table></div></div>
                            </div></div>`;
            }
        };

        function formatEmailFromName(name) {
            const sanitized = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            return `${sanitized}@er-queue.system`;
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                const unitDoc = await getDoc(doc(db, "units", user.uid));
                if (unitDoc.exists()) {
                    state.unitName = unitDoc.data().name;
                    dom.unitNameDisplay.textContent = state.unitName;
                }
                dom.authContainer.classList.add('hidden');
                dom.mainAppContainer.classList.remove('hidden');
                navigateTo('reception');
                setupPatientListener();
            } else {
                state.user = null;
                state.patients = [];
                state.unitName = '';
                dom.authContainer.classList.remove('hidden');
                dom.mainAppContainer.classList.add('hidden');
                showAuthView('login');
            }
        });

        function setupPatientListener() {
            if (state.unsubscribe) state.unsubscribe();
            const q = query(collection(db, `units/${state.user.uid}/patients`), orderBy("receptionTimestamp", "desc"));
            state.unsubscribe = onSnapshot(q, (querySnapshot) => {
                state.patients = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Erro ao buscar pacientes: ", error));
        }

        function render() {
            if (!state.user) return;
            const viewContent = renderTemplates[state.currentView]();
            const viewElement = document.getElementById(`${state.currentView}-view`);
            if(viewElement) viewElement.innerHTML = viewContent;

            // Audio notification
            const lastCalled = state.patients.find(p => p.status === 'chamado-medico' || p.status === 'chamado-triagem');
            if (lastCalled && state.lastCalledPatientId !== lastCalled.id) {
                state.lastCalledPatientId = lastCalled.id;
                const audio = new Audio('https://actions.google.com/sounds/v1/alarms/notification_high_intensity.ogg');
                audio.play().catch(e => console.log("Audio play failed:", e));
            }
        }
        
        function navigateTo(view) {
            state.currentView = view;
            dom.views.forEach(v => v.classList.remove('active'));
            const activeView = document.getElementById(`${view}-view`);
            if (activeView) activeView.classList.add('active');
            dom.navButtons.forEach(btn => btn.classList.toggle('ring-2', btn.dataset.view === view));
            render();
        }

        function showAuthView(view) {
            dom.loginView.classList.toggle('active', view === 'login');
            dom.registerView.classList.toggle('active', view === 'register');
        }

        dom.showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showAuthView('register'); });
        dom.showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthView('login'); });

        dom.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            dom.loginError.textContent = '';
            const unitName = dom.loginForm['login-unit-name'].value;
            const password = dom.loginForm['login-password'].value;
            const email = formatEmailFromName(unitName);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                dom.loginError.textContent = 'Nome da unidade ou senha inválidos.';
            }
        });

        dom.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            dom.registerError.textContent = '';
            const unitName = dom.registerForm['register-unit-name'].value;
            const password = dom.registerForm['register-password'].value;
            if(password.length < 6) {
                dom.registerError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                return;
            }
            const email = formatEmailFromName(unitName);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "units", userCredential.user.uid), { name: unitName });
            } catch (error) {
                dom.registerError.textContent = 'Não foi possível cadastrar. A unidade já pode existir.';
            }
        });
        
        dom.logoutBtn.addEventListener('click', () => signOut(auth));
        dom.navButtons.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));

        document.body.addEventListener('submit', async e => {
            if (e.target.id === 'add-patient-form') {
                e.preventDefault();
                const name = e.target['patient-name'].value.trim();
                const age = parseInt(e.target['patient-age'].value);
                const isPriority = e.target['is-priority'].checked;
                if (name && age && state.user) {
                    await addDoc(collection(db, `units/${state.user.uid}/patients`), { name, age, isPriority, status: 'aguardando-triagem', receptionTimestamp: serverTimestamp() });
                    e.target.reset();
                }
            }
        });

        // Event delegation for all other actions
        document.body.addEventListener('click', async e => {
            const action = e.target.dataset.action;
            const id = e.target.dataset.id;
            if (!action || !id) return;

            const patientRef = doc(db, `units/${state.user.uid}/patients`, id);

            switch(action) {
                case 'call-for-triage': await makeCall(id, 'triage'); break;
                case 'start-triage':
                    await updateDoc(patientRef, { status: 'em-triagem', triagedBy: state.user.uid });
                    showTriageModal(id);
                    break;
                case 'call-patient': await makeCall(id, 'doctor'); break;
                case 'finish-consultation': await updateDoc(patientRef, { status: 'atendido' }); break;
                case 'submit-triage': {
                    const priority = parseInt(document.getElementById('priority-select').value);
                    if(priority) {
                       await updateDoc(patientRef, { status: 'aguardando-atendimento', priority, triageTimestamp: serverTimestamp() });
                       hideModal();
                    }
                    break;
                }
                case 'analyze-symptoms': /* (rest of the logic remains the same) */ break;
                case 'generate-summary': /* (rest of the logic remains the same) */ break;
            }
        });

        function showModal(content) { dom.modal.classList.remove('hidden'); dom.modalContent.innerHTML = content; }
        function hideModal() { dom.modal.classList.add('hidden'); dom.modalContent.innerHTML = ''; }
        dom.modal.addEventListener('click', e => { if (e.target.id === 'modal' || e.target.matches('[data-action="close-modal"]')) hideModal(); });

        async function makeCall(patientId, callType) {
            const currentlyCalled = state.patients.find(p => p.status === 'chamado-medico' || p.status === 'chamado-triagem');
            if (currentlyCalled && currentlyCalled.id !== patientId) {
                const oldPatientRef = doc(db, `units/${state.user.uid}/patients`, currentlyCalled.id);
                const newStatus = currentlyCalled.status === 'chamado-medico' ? 'em-atendimento' : 'em-triagem';
                await updateDoc(oldPatientRef, { status: newStatus });
            }
            const newPatientRef = doc(db, `units/${state.user.uid}/patients`, patientId);
            const updateData = { status: callType === 'doctor' ? 'chamado-medico' : 'chamado-triagem', callTimestamp: serverTimestamp() };
            if (callType === 'doctor') updateData.attendedBy = state.user.uid;
            await updateDoc(newPatientRef, updateData);
        }

        function showTriageModal(patientId) {
             const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            const content = `
                <h3 class="text-lg leading-6 font-medium text-gray-900">${patient.isPriority ? '⭐' : ''} ${patient.name}</h3>
                <div class="mt-2 px-2 py-3 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-left">Sintomas</label>
                        <textarea id="triage-symptoms" class="mt-1 block w-full rounded-md p-2" rows="3"></textarea>
                        <button data-action="analyze-symptoms" data-id="${patientId}" class="mt-2 w-full bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg text-sm">✨ Analisar Sintomas com IA</button>
                        <div id="ai-analysis-result" class="mt-2"></div>
                    </div>
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 text-left">Nível de Prioridade</label>
                        <select id="priority-select" class="mt-1 block w-full rounded-md p-2">
                            <option value="1">1 - Emergência</option> <option value="2">2 - Muito Urgente</option>
                            <option value="3" selected>3 - Urgente</option> <option value="4">4 - Pouco Urgente</option>
                            <option value="5">5 - Não Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="items-center px-4 py-3 bg-gray-50 -mx-5 -mb-5 mt-4 rounded-b-md">
                    <button data-action="submit-triage" data-id="${patientId}" class="px-4 py-2 bg-green-500 text-white rounded-md w-full">Enviar para Fila Médica</button>
                    <button data-action="close-modal" class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md w-full">Cancelar</button>
                </div>`;
            showModal(content);
        }

    </script>
</body>
</html>

